{
  "hash": "4c89ff989202649fd4f6b62884e4502e",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"5 Régression polynomiale et régression spline\"\ntoc: true\n---\n\n::: {#6b0939e5 .cell execution_count=1}\n``` {.python .cell-code}\nimport numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nfrom scipy.interpolate import make_smoothing_spline\nimport statsmodels.formula.api as smf\nimport statsmodels.api as sm\nfrom patsy import dmatrix \n```\n:::\n\n\n#   Régression polynomiale\n\n::: {#d89dd25f .cell execution_count=2}\n``` {.python .cell-code}\nozone = pd.read_csv(\"../donnees/ozone_simple.txt\", header=0, sep=\";\")\n```\n:::\n\n\n::: {#3eec6ef4 .cell execution_count=3}\n``` {.python .cell-code}\nfig = plt.figure()\nplt.plot(ozone.T12, ozone.O3, '.k')\nplt.ylabel('O3')\nplt.xlabel('T12')\nfig.tight_layout()\n```\n\n::: {.cell-output .cell-output-display}\n![](chap5_files/figure-html/cell-4-output-1.png){width=661 height=468}\n:::\n:::\n\n\n::: {#e604c131 .cell execution_count=4}\n``` {.python .cell-code}\ndef polyreg(donnee, d=3):\n    sigmax = donnee.T12.std()\n    mini = donnee.T12.min() -sigmax\n    maxi = donnee.T12.max()+sigmax\n    grillex = np.linspace(mini, maxi, 100)\n    aprevoir = pd.DataFrame({\"T12\": grillex})\n    formula = \"O3~1\"\n    for deg in range(d):\n        if deg>0:\n            formula = formula + \"+ np.power(T12,\" + str(deg+1) + \")\"\n        else:\n            formula = formula + \"+ T12\"\n    repol = smf.ols(formula, donnee).fit()\n    prev = repol.predict(aprevoir)\n    return {\"grillex\": grillex, \"grilley\": prev}\n```\n:::\n\n\n::: {#e5f36a0e .cell execution_count=5}\n``` {.python .cell-code}\nligne = ['-', '--', ':', '-.']\nfig, ax = plt.subplots(1, 1)\nfor iter, ii in enumerate([1,2,3,9]):\n    tmp = polyreg(ozone, d=ii)\n    ax.plot(tmp[\"grillex\"], tmp[\"grilley\"], ls=ligne[iter])\n\nax.set_xlabel(\"T12\")\nax.set_ylabel(\"O3\")\nax.set_xlim(0, 45)\nax.set_ylim(0, 150)\nax.legend(['d=1', 'd=2', 'd=3', 'd=9'])\nax.plot(ozone.T12, ozone.O3, \"k+\")\nfig.tight_layout()\n```\n\n::: {.cell-output .cell-output-display}\n![](chap5_files/figure-html/cell-6-output-1.png){width=661 height=468}\n:::\n:::\n\n\n::: {#68649504 .cell execution_count=6}\n``` {.python .cell-code}\noz = ozone.copy()\noz.loc[oz.T12==7.9,\"T12\"] = 13\nligne = ['-', '--', ':', '-.']\nfig, (ax1, ax2) = plt.subplots(2, 1)\nfor iter, ii in enumerate([1,2,3,9]):\n    tmp = polyreg(ozone, d=ii)\n    ax1.plot(tmp[\"grillex\"], tmp[\"grilley\"], ls=ligne[iter])\n\nax1.set_ylabel(\"O3\")\nax1.set_xlim(5,35)\nax1.set_ylim(5, 150)\nax1.plot(ozone.T12, ozone.O3, \"k+\")\nfor iter, ii in enumerate([1,2,3,9]):\n    tmp = polyreg(oz, d=ii)\n    ax2.plot(tmp[\"grillex\"], tmp[\"grilley\"], ls=ligne[iter])\n\nax2.set_xlabel(\"T12\")\nax2.set_ylabel(\"O3\")\nax2.set_xlim(5,35)\nax2.set_ylim(5, 150)\nax2.plot(oz.T12, oz.O3, \"k+\")\nfig.tight_layout()\n```\n\n::: {.cell-output .cell-output-display}\n![](chap5_files/figure-html/cell-7-output-1.png){width=661 height=468}\n:::\n:::\n\n\n::: {#c1067ee2 .cell execution_count=7}\n``` {.python .cell-code}\noz = ozone.copy()\noz = oz.loc[oz.T12!=oz.T12.min(),:]\nligne = ['-', '--', ':', '-.']\nfig, (ax1, ax2) = plt.subplots(2, 1)\nfor iter, ii in enumerate([1,2,3,9]):\n    tmp = polyreg(ozone, d=ii)\n    ax1.plot(tmp[\"grillex\"], tmp[\"grilley\"], ls=ligne[iter])\n\nax1.set_ylabel(\"O3\")\nax1.set_xlim(5,35)\nax1.set_ylim(5, 150)\nax1.plot(ozone.T12, ozone.O3, \"k+\")\nfor iter, ii in enumerate([1,2,3,9]):\n    tmp = polyreg(oz, d=ii)\n    ax2.plot(tmp[\"grillex\"], tmp[\"grilley\"], ls=ligne[iter])\n\nax2.set_xlabel(\"T12\")\nax2.set_ylabel(\"O3\")\nax2.set_xlim(5,35)\nax2.set_ylim(5, 150)\nax2.plot(oz.T12, oz.O3, \"k+\")\nfig.tight_layout()\n```\n\n::: {.cell-output .cell-output-display}\n![](chap5_files/figure-html/cell-8-output-1.png){width=661 height=468}\n:::\n:::\n\n\n#   Régression spline\n\n::: {#0edc8364 .cell execution_count=8}\n``` {.python .cell-code}\nind = ozone.T12 < 23\nregd = smf.ols(\"O3~T12\", data=ozone.loc[ind,:]).fit()\nregf = smf.ols(\"O3~T12\", data=ozone.loc[~ind,:]).fit()\ngxd = np.linspace(3,23,21)\ngxf = np.linspace(23,30,8)\nprd = regd.params.iloc[0] +regd.params.iloc[1]*gxd\nprf = regf.params.iloc[0] +regf.params.iloc[1]*gxf\nfig, ax = plt.subplots(1, 1)\nax.plot(ozone.T12, ozone.O3, \"k+\", gxd, prd, \"k-\", gxf, prf, \"k-\")\nax.set_xlabel(\"T12\")\nax.set_ylabel(\"O3\")\nax.axvline(x=23, color=\"k\")\nfig.tight_layout()\n```\n\n::: {.cell-output .cell-output-display}\n![](chap5_files/figure-html/cell-9-output-1.png){width=661 height=468}\n:::\n:::\n\n\n::: {#77921a38 .cell execution_count=9}\n``` {.python .cell-code}\nxi = [15, 23]\nBS = dmatrix(\"~ 1 + bs(T12, degree=2, knots=xi, include_intercept=False, lower_bound=5, upper_bound=32)\", ozone, return_type=\"dataframe\")\nBS.columns = [\"bs\" + str(i+1) for i in range(5)]\ndf = pd.concat([ozone.O3, BS.iloc[:,1:]], axis=1)\n\nregs = smf.ols(\"O3~1+bs2+bs3+bs4+bs5 \", df).fit()\nprint(regs.params.round(3))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nIntercept     51.102\nbs2           61.544\nbs3            5.562\nbs4           70.459\nbs5          106.712\ndtype: float64\n```\n:::\n:::\n\n\n::: {#1fb38dd6 .cell execution_count=10}\n``` {.python .cell-code}\nregs = smf.ols(\"O3~ 1 + bs(T12, degree=2, knots=xi, include_intercept=False, lower_bound=5, upper_bound=32)\", ozone).fit()\nprint(list(regs.params.round(3)))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[51.102, 61.544, 5.562, 70.459, 106.712]\n```\n:::\n:::\n\n\n::: {#28c06f9b .cell execution_count=11}\n``` {.python .cell-code}\ndf = pd.DataFrame({\"T12\": np.linspace(5,32,100)})\nprev = regs.predict(df)\nfig, ax = plt.subplots(1, 1)\nax.plot(ozone.T12, ozone.O3, \"ko\" , df.T12, prev, \"-\")\nax.set_xlabel(\"T12\")\nax.set_ylabel(\"O3\")\nax.axvline(x=15, color=\"k\", ls=\"-\")\nax.axvline(x=xi[1], color=\"k\", ls=\"-\")\nfig.tight_layout()\n```\n\n::: {.cell-output .cell-output-display}\n![](chap5_files/figure-html/cell-12-output-1.png){width=661 height=468}\n:::\n:::\n\n\n::: {#b117d60f .cell execution_count=12}\n``` {.python .cell-code}\nozdedup = ozone.groupby(\"T12\").mean()\nozdedup[\"w\"] = ozone.groupby(\"T12\").count()\nspl = make_smoothing_spline(ozdedup.index, ozdedup.O3, ozdedup.w, lam=10000)\nxi = np.linspace(ozdedup.index[0], ozdedup.index[-1], 150)\nyi = spl(xi)\nfig, ax = plt.subplots(1, 1)\nax.plot(ozone.T12, ozone.O3, \"ko\" , xi, yi, \"-\")\nax.set_xlabel(\"T12\")\nax.set_ylabel(\"O3\")\nfig.tight_layout()\n```\n\n::: {.cell-output .cell-output-display}\n![](chap5_files/figure-html/cell-13-output-1.png){width=661 height=468}\n:::\n:::\n\n\n::: {#f7891027 .cell execution_count=13}\n``` {.python .cell-code}\nspl = make_smoothing_spline(ozdedup.index, ozdedup.O3, ozdedup.w, lam=1e-2)\nxi = np.linspace(ozdedup.index[0], ozdedup.index[-1], 150)\nyi = spl(xi)\nfig, ax = plt.subplots(1, 1)\nax.plot(ozone.T12, ozone.O3, \"ko\" , xi, yi, \"-\")\nax.set_xlabel(\"T12\")\nax.set_ylabel(\"O3\")\nfig.tight_layout()\n```\n\n::: {.cell-output .cell-output-display}\n![](chap5_files/figure-html/cell-14-output-1.png){width=661 height=468}\n:::\n:::\n\n\n::: {#9c5b2288 .cell execution_count=14}\n``` {.python .cell-code}\nozdedup = ozone.groupby(\"T12\").mean()\nozdedup[\"w\"] = ozone.groupby(\"T12\").count()\nspl = make_smoothing_spline(ozdedup.index, ozdedup.O3, ozdedup.w)\nxi = np.linspace(ozdedup.index[0], ozdedup.index[-1], 150)\nyi = spl(xi)\nfig, ax = plt.subplots(1, 1)\nax.plot(ozone.T12, ozone.O3, \"ko\" , xi, yi, \"-\")\nax.set_xlabel(\"T12\")\nax.set_ylabel(\"O3\")\nfig.tight_layout()\n```\n\n::: {.cell-output .cell-output-display}\n![](chap5_files/figure-html/cell-15-output-1.png){width=661 height=468}\n:::\n:::\n\n\n",
    "supporting": [
      "chap5_files/figure-html"
    ],
    "filters": [],
    "includes": {}
  }
}