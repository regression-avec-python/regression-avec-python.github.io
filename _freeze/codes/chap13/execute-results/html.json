{
  "hash": "bae64d5395e183b01ab95dc77cd2f781",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"13 Régression de Poisson\"\ntoc: true\n---\n\n::: {#18e5f1f7 .cell execution_count=1}\n``` {.python .cell-code}\nimport pandas as pd; import numpy as np\nimport matplotlib.pyplot as plt\nimport scipy as sp\nfrom scipy import stats\nimport statsmodels.formula.api as smf\nimport statsmodels.api as sm\nimport statsmodels.regression.linear_model as smlm\nimport sys\nsys.path.append('../modules')\nimport choixglmstats\n```\n:::\n\n\n#   Le modèle linéaire généralisé\n\n#   Exemple : modélisation du nombre de visites\n\n::: {#6b914fbd .cell execution_count=2}\n``` {.python .cell-code}\nMalaria = pd.read_csv(\"../donnees/poissonData3.csv\", header=0, sep=',')\nMalaria[\"Sexe\"] = Malaria[\"Sexe\"].astype(\"category\")\nMalaria[\"Prev\"] = Malaria[\"Prev\"].astype(\"category\")\nprint(Malaria.describe())\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n               Age     Altitude        Duree     Nmalaria\ncount  1627.000000  1522.000000  1627.000000  1627.000000\nmean    419.359557  1294.714389   619.263061     4.687154\nstd     247.929838    44.198415   420.990175     4.153109\nmin      10.000000  1129.000000     0.000000     0.000000\n25%     220.000000  1266.000000   172.000000     1.000000\n50%     361.000000  1298.000000   721.000000     4.000000\n75%     555.000000  1320.000000  1011.000000     7.000000\nmax    1499.000000  1515.000000  1464.000000    26.000000\n```\n:::\n:::\n\n\n::: {#2614c45d .cell execution_count=3}\n``` {.python .cell-code}\nprint(Malaria.isna().sum(axis=0))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSexe          0\nAge           0\nAltitude    105\nPrev          0\nDuree         0\nNmalaria      0\ndtype: int64\n```\n:::\n:::\n\n\n::: {#38de08c4 .cell execution_count=4}\n``` {.python .cell-code}\nMalaria = Malaria[[\"Sexe\",\"Prev\",\"Duree\",\"Nmalaria\"]]\nplt.plot(Malaria.Duree, Malaria.Nmalaria, 'o')\n```\n\n::: {.cell-output .cell-output-display}\n![](chap13_files/figure-html/cell-5-output-1.png){width=566 height=411}\n:::\n:::\n\n\n::: {#7f7ebe21 .cell execution_count=5}\n``` {.python .cell-code}\nfig = plt.figure()\nmodele = smf.ols(\"Nmalaria ~ 1+ Duree\", data = Malaria).fit()\nplt.plot(Malaria.Duree, Malaria.Nmalaria, 'o')\ngrille = pd.DataFrame({'Duree': np.linspace(Malaria.Duree.min(), Malaria.Duree.max(), 2)})\ncalcprev = modele.get_prediction(grille)\nplt.plot(Malaria.Duree, Malaria.Nmalaria, 'o', grille.Duree,  calcprev.predicted_mean, '-')\nfig.tight_layout()\n```\n\n::: {.cell-output .cell-output-display}\n![](chap13_files/figure-html/cell-6-output-1.png){width=662 height=469}\n:::\n:::\n\n\n::: {#9a933484 .cell execution_count=6}\n``` {.python .cell-code}\nmodP = smf.glm(\"Nmalaria ~ 1+ Duree\", data = Malaria, family=sm.families.Poisson()).fit()\nmodP.summary()\n```\n\n::: {.cell-output .cell-output-display execution_count=6}\n```{=html}\n<table class=\"simpletable\">\n<caption>Generalized Linear Model Regression Results</caption>\n<tr>\n  <th>Dep. Variable:</th>       <td>Nmalaria</td>     <th>  No. Observations:  </th>  <td>  1627</td> \n</tr>\n<tr>\n  <th>Model:</th>                  <td>GLM</td>       <th>  Df Residuals:      </th>  <td>  1625</td> \n</tr>\n<tr>\n  <th>Model Family:</th>         <td>Poisson</td>     <th>  Df Model:          </th>  <td>     1</td> \n</tr>\n<tr>\n  <th>Link Function:</th>          <td>Log</td>       <th>  Scale:             </th> <td>  1.0000</td>\n</tr>\n<tr>\n  <th>Method:</th>                <td>IRLS</td>       <th>  Log-Likelihood:    </th> <td> -4060.3</td>\n</tr>\n<tr>\n  <th>Date:</th>            <td>Tue, 04 Feb 2025</td> <th>  Deviance:          </th> <td>  3325.2</td>\n</tr>\n<tr>\n  <th>Time:</th>                <td>14:27:57</td>     <th>  Pearson chi2:      </th> <td>3.17e+03</td>\n</tr>\n<tr>\n  <th>No. Iterations:</th>          <td>5</td>        <th>  Pseudo R-squ. (CS):</th>  <td>0.7691</td> \n</tr>\n<tr>\n  <th>Covariance Type:</th>     <td>nonrobust</td>    <th>                     </th>     <td> </td>   \n</tr>\n</table>\n<table class=\"simpletable\">\n<tr>\n      <td></td>         <th>coef</th>     <th>std err</th>      <th>z</th>      <th>P>|z|</th>  <th>[0.025</th>    <th>0.975]</th>  \n</tr>\n<tr>\n  <th>Intercept</th> <td>    0.4295</td> <td>    0.031</td> <td>   13.853</td> <td> 0.000</td> <td>    0.369</td> <td>    0.490</td>\n</tr>\n<tr>\n  <th>Duree</th>     <td>    0.0015</td> <td> 3.42e-05</td> <td>   44.144</td> <td> 0.000</td> <td>    0.001</td> <td>    0.002</td>\n</tr>\n</table>\n```\n:::\n:::\n\n\n::: {#626db8a4 .cell execution_count=7}\n``` {.python .cell-code}\nfig = plt.figure()\nplt.plot(Malaria.Duree, Malaria.Nmalaria, 'o')\ngrille2 = pd.DataFrame({'Duree': np.linspace(Malaria.Duree.min(), Malaria.Duree.max(), 1500)})\ncalcprev2 = modP.get_prediction(grille2)\nplt.plot(Malaria.Duree, Malaria.Nmalaria, 'o', grille.Duree,  calcprev.predicted_mean, '-', grille2.Duree,  calcprev2.predicted_mean, '--')\nfig.tight_layout()\n```\n\n::: {.cell-output .cell-output-display}\n![](chap13_files/figure-html/cell-8-output-1.png){width=662 height=469}\n:::\n:::\n\n\n#   Régression log-linéaire\n\n::: {#f640636f .cell execution_count=8}\n``` {.python .cell-code}\nmodP3 = smf.glm(\"Nmalaria ~ 1+ Duree + Sexe + Prev\", data = Malaria, family=sm.families.Poisson()).fit()\nprint(modP3.summary())\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                 Generalized Linear Model Regression Results                  \n==============================================================================\nDep. Variable:               Nmalaria   No. Observations:                 1627\nModel:                            GLM   Df Residuals:                     1621\nModel Family:                 Poisson   Df Model:                            5\nLink Function:                    Log   Scale:                          1.0000\nMethod:                          IRLS   Log-Likelihood:                -4056.3\nDate:                Tue, 04 Feb 2025   Deviance:                       3317.3\nTime:                        14:27:57   Pearson chi2:                 3.17e+03\nNo. Iterations:                     5   Pseudo R-squ. (CS):             0.7703\nCovariance Type:            nonrobust                                         \n===========================================================================================\n                              coef    std err          z      P>|z|      [0.025      0.975]\n-------------------------------------------------------------------------------------------\nIntercept                   0.1623      0.180      0.900      0.368      -0.191       0.516\nSexe[T.M]                   0.0551      0.023      2.398      0.016       0.010       0.100\nPrev[T.Moustiquaire]        0.2433      0.177      1.371      0.170      -0.105       0.591\nPrev[T.Rien]                0.2256      0.178      1.266      0.205      -0.124       0.575\nPrev[T.Serpentin/Spray]     0.2452      0.185      1.324      0.185      -0.118       0.608\nDuree                       0.0015   3.43e-05     44.031      0.000       0.001       0.002\n===========================================================================================\n```\n:::\n:::\n\n\n::: {#4b26e8be .cell execution_count=9}\n``` {.python .cell-code}\nmod3= smf.glm(\"Nmalaria ~ 1+ Duree + Sexe + C(Prev, Treatment('Rien'))\", data = Malaria, family=sm.families.Poisson()).fit()\nprint(mod3.summary())\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                 Generalized Linear Model Regression Results                  \n==============================================================================\nDep. Variable:               Nmalaria   No. Observations:                 1627\nModel:                            GLM   Df Residuals:                     1621\nModel Family:                 Poisson   Df Model:                            5\nLink Function:                    Log   Scale:                          1.0000\nMethod:                          IRLS   Log-Likelihood:                -4056.3\nDate:                Tue, 04 Feb 2025   Deviance:                       3317.3\nTime:                        14:27:57   Pearson chi2:                 3.17e+03\nNo. Iterations:                     5   Pseudo R-squ. (CS):             0.7703\nCovariance Type:            nonrobust                                         \n=================================================================================================================\n                                                    coef    std err          z      P>|z|      [0.025      0.975]\n-----------------------------------------------------------------------------------------------------------------\nIntercept                                         0.3879      0.039      9.951      0.000       0.311       0.464\nSexe[T.M]                                         0.0551      0.023      2.398      0.016       0.010       0.100\nC(Prev, Treatment('Rien'))[T.Autre]              -0.2256      0.178     -1.266      0.205      -0.575       0.124\nC(Prev, Treatment('Rien'))[T.Moustiquaire]        0.0177      0.026      0.691      0.490      -0.032       0.068\nC(Prev, Treatment('Rien'))[T.Serpentin/Spray]     0.0196      0.059      0.333      0.739      -0.096       0.135\nDuree                                             0.0015   3.43e-05     44.031      0.000       0.001       0.002\n=================================================================================================================\n```\n:::\n:::\n\n\n::: {#e252120e .cell execution_count=10}\n``` {.python .cell-code}\nmodP2= smf.glm(\"Nmalaria ~ 1+ Duree + Sexe \", data = Malaria, family=sm.families.Poisson()).fit()\n```\n:::\n\n\n::: {#4627c804 .cell execution_count=11}\n``` {.python .cell-code}\nsmlm.RegressionResults.compare_lr_test(modP3,modP2)\n```\n\n::: {.cell-output .cell-output-display execution_count=11}\n```\n(2.4488233421689074, 0.4846108842015914, 3)\n```\n:::\n:::\n\n\n::: {#27a1a390 .cell execution_count=12}\n``` {.python .cell-code}\nsp.stats.chi2.ppf(0.95,3)\n```\n\n::: {.cell-output .cell-output-display execution_count=12}\n```\n7.814727903251179\n```\n:::\n:::\n\n\n::: {#2bccd227 .cell execution_count=13}\n``` {.python .cell-code}\nprint(modP3.conf_int(alpha=0.05))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                                0         1\nIntercept               -0.191170  0.515791\nSexe[T.M]                0.010071  0.100107\nPrev[T.Moustiquaire]    -0.104566  0.591101\nPrev[T.Rien]            -0.123561  0.574727\nPrev[T.Serpentin/Spray] -0.117722  0.608171\nDuree                    0.001443  0.001577\n```\n:::\n:::\n\n\n::: {#142ab738 .cell execution_count=14}\n``` {.python .cell-code}\nMalaria = pd.read_csv(\"../donnees/poissonData.csv\", header=0, sep=\",\")\nMalaria.dropna(axis=0, inplace=True)\n```\n:::\n\n\n::: {#e3c5e2a0 .cell execution_count=15}\n``` {.python .cell-code}\nform =\"Nmalaria ~ \" + \"+\".join(Malaria.columns[ :-1 ])\nmod_sel = choixglmstats.bestglm(Malaria, upper=form, family=sm.families.Poisson())\n```\n:::\n\n\n::: {#4d7ec995 .cell execution_count=16}\n``` {.python .cell-code}\nprint(mod_sel.sort_values(by=[\"BIC\",\"nb_var\"]).iloc[:3,[1,3]])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                       var_added          BIC\n13        (Altitude, Duree, Age)  7392.274194\n20             (Altitude, Duree)  7395.141592\n2   (Sexe, Altitude, Duree, Age)  7397.380825\n```\n:::\n:::\n\n\n::: {#8c168ac8 .cell execution_count=17}\n``` {.python .cell-code}\nprint(mod_sel.sort_values(by=[\"AIC\",\"nb_var\"]).iloc[:3,[1,2]])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                             var_added          AIC\n2         (Sexe, Altitude, Duree, Age)  7370.741923\n13              (Altitude, Duree, Age)  7370.963072\n0   (Sexe, Altitude, Duree, Prev, Age)  7374.648450\n```\n:::\n:::\n\n\n",
    "supporting": [
      "chap13_files/figure-html"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}