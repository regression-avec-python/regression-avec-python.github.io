---
title: "Variables qualitatives : ANCOVA et ANOVA"
toc: true
---



```{python}
import pandas as pd; import numpy as np
import matplotlib.pyplot as plt
import matplotlib.cm as cm
import seaborn as sns
import statsmodels.api as sm
import statsmodels.formula.api as smf
from statsmodels.graphics import regressionplots
from statsmodels.graphics.api import interaction_plot
from patsy import dmatrix, ContrastMatrix
```

```{python}
fig = plt.figure()
eucalypt = pd.read_csv("../donnees/eucalyptus.txt", header = 0, sep = ";")
eucalypt["bloc"] = eucalypt["bloc"].astype("category")
sns.scatterplot(data=eucalypt, x="circ", y="ht", hue="bloc",style='bloc')
fig.tight_layout()

```

#   La concentration en ozone

```{python}
ozone = pd.read_csv("../donnees/ozone.txt", header = 0, sep = ";")
ozone["vent"]=ozone["vent"].astype("category")


niveau = ozone["vent"].cat.categories
cc = cm.Set1(range(niveau.size))
mm = ["o","*","8","s"]
fig, ax = plt.subplots()
for i, val in enumerate(niveau):
    print(val)
    reg = smf.ols("O3 ~ 1 + T12",data=ozone.loc[ozone["vent"]==val]).fit()
    plt.scatter(ozone.loc[ozone["vent"]==val,"T12"],ozone.loc[ozone["vent"]==val,"O3"],
                color=cc[i],label=val, marker=mm[i])
    regressionplots.abline_plot(model_results=reg, ax=ax, color=cc[i])

plt.legend()
fig.tight_layout()
```


```{python}
mod1b = smf.ols('O3 ~ -1 + vent + T12:vent', data = ozone).fit()
mod1b.summary()
```


```{python}
mod1 =smf.ols('O3 ~ vent + T12:vent', data = ozone).fit()
mod1.summary()

```


```{python}
mod2 = smf.ols('O3 ~ vent + T12', data = ozone).fit()
mod2b = smf.ols('O3 ~ -1 + vent + T12', data = ozone).fit()
mod3 = smf.ols('O3 ~ vent:T12', data = ozone).fit()

round(sm.stats.anova_lm(mod2,mod1),3)
```
```{python}
round(sm.stats.anova_lm(mod3,mod1),3)
```


```{python}
infl = mod2.get_influence()
fig = plt.figure()
plt.plot(mod2.fittedvalues,infl.resid_studentized_external,".")
plt.ylabel('résidus')
plt.xlabel(r'$\hat Y$')
fig.tight_layout()

```


```{python}
fitted2 = mod2.fittedvalues
sns.set(style="whitegrid")
fitted3 = 1/5* abs(fitted2.round(3))
dfresid = pd.concat([fitted2, pd.Series(infl.resid_studentized_external), ozone[["O3", "vent"]]], axis=1)
dfresid.columns=["residus", "ajustement", "O3", "vent"]
g = sns.FacetGrid(dfresid, col="vent")
g = g.map(plt.scatter, "ajustement", "residus")
fig.tight_layout()

```


```{python}
mod = smf.ols('O3 ~ vent + T12 + T12:vent', data = ozone).fit()
mod.summary()
```

#   La hauteur des eucalyptus


```{python}
eucalypt = pd.read_csv("../donnees/eucalyptus.txt", header = 0, sep = ";")
eucalypt["bloc"] = eucalypt["bloc"].astype("category")
m_complet = smf.ols("ht ~ - 1 + bloc + bloc:circ", data = eucalypt).fit()
m_pente = smf.ols("ht ~  - 1 + bloc + circ", data = eucalypt).fit()
m_ordonne = smf.ols("ht ~ 1 + bloc:circ", data = eucalypt).fit()
sm.stats.anova_lm(m_pente, m_complet)
```


```{python}
round(sm.stats.anova_lm(m_ordonne, m_complet),3)
```


```{python}
m_simple = smf.ols("ht ~ 1 + circ", data = eucalypt).fit()
round(sm.stats.anova_lm(m_simple,m_pente),3)
```


```{python}
plt.rc("lines", markersize=3) #
infl = m_pente.get_influence()
fig = plt.figure()
plt.plot(m_pente.fittedvalues,infl.resid_studentized_external,".")
plt.ylabel('résidus')
plt.xlabel(r'$\hat Y$')
fig.tight_layout()

```

#   ANOVA


```{python}
niveau = ozone["vent"].cat.categories
O3_parvent = []
for i in range(niveau.size):
    O3_parvent.append(list(ozone.loc[ozone["vent"]==niveau[i],"O3"]))
    
fig, ax = plt.subplots(1,1)
bplot = ax.boxplot(O3_parvent,patch_artist=True,tick_labels=niveau )
for patch in bplot["boxes"]:
     patch.set_facecolor("#5875a4")

fig.tight_layout()

```



```{python}
mod1 = smf.ols("O3~vent-1",data=ozone).fit()
mod1.summary()
```

```{python}
round(sm.stats.anova_lm(mod1),3)
```


```{python}
mod2 = smf.ols("O3 ~ vent", data = ozone).fit()
mod2.summary()
```


```{python}
round(sm.stats.anova_lm(mod2),3)
```


```{python}
smf.ols("O3 ~ C(vent,Treatment)", data = ozone).fit().params
```


```{python}
smf.ols("O3 ~ C(vent, levels=['NORD', 'EST', 'OUEST', 'SUD'])", \
    data = ozone).fit().params
```


```{python}
II = ozone["vent"].cat.categories.size
nI = ozone["vent"].value_counts()[ozone["vent"].cat.categories]
contr_mat = np.vstack([np.eye(II-1), (-nI[:(II-1)]).divide(nI[-1])])
contraste = ContrastMatrix(contr_mat, ["[a1]", "[a2]", "[a3]"])
mod3 = smf.ols("O3 ~ 1 + C(vent,contraste)",data=ozone).fit()
mod3.summary()
```


```{python}
round(sm.stats.anova_lm(mod3),3)
```


```{python}
mod4 = smf.ols("O3 ~ 1+ C(vent,Sum)", data = ozone).fit()
round(sm.stats.anova_lm(mod4),3)
```

```{python}
print(ozone)
```

```{python}
ozone = pd.read_csv("../donnees/ozone.txt", header = 0, sep = ";")
ozone["vent"]=ozone["vent"].astype("category")
ozone["nebu"]=ozone["nebu"].astype("category")
plt.rcParams['font.size'] = '7'
from statsmodels.graphics.api import interaction_plot
cc2 = cm.Set1(range(ozone["vent"].cat.categories.size))
fig, axs = plt.subplots(1,2)
plt.rcParams['font.size'] = '4'
interaction_plot(ozone["vent"].astype("str"), ozone["nebu"].astype("str"), ozone["O3"], colors=cc2[:2], markers=['^','D'],ax=axs[0])
interaction_plot( ozone["nebu"].astype("str"), ozone["vent"].astype("str"),ozone["O3"], colors=cc2, markers=['^','D',"*","8"],ax=axs[1])
fig.tight_layout()
```


```{python}
mod1 = smf.ols("O3 ~ vent + nebu + vent:nebu", data = ozone).fit()
mod2 = smf.ols("O3 ~ vent + nebu ", data = ozone).fit()
sm.stats.anova_lm(mod2,mod1)
```


```{python}
mod3 = smf.ols("O3 ~ vent", data = ozone).fit()
round(sm.stats.anova_lm(mod3,mod2),3)
```


```{python}
round(sm.stats.anova_lm(mod3, mod2, mod1),3)
```


```{python}
round(sm.stats.anova_lm(mod1),3)
```